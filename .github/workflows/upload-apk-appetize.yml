name: Upload APK to Appetize.io

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  upload-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Debug Information
        run: |
          echo "::group::Environment & Permissions"
          echo "Event Name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow Permissions:"
          echo "  - contents: write"
          echo "  - pull-requests: write"
          echo "  - issues: write"
          echo "::endgroup::"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better context
      
      # Setup Java and Android build environment
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew 2>/dev/null || echo "No gradlew found, will use gradle command"
      
      # Build the Android APK
      - name: Build Android APK
        run: |
          echo "::group::Building Android APK"
          
          # Build debug APK (faster and doesn't require signing for Appetize.io)
          if [ -f "gradlew" ]; then
            ./gradlew assembleDebug --no-daemon --stacktrace
          else
            gradle assembleDebug --no-daemon --stacktrace
          fi
          
          echo "âœ“ APK build completed"
          echo "::endgroup::"
      
      - name: Search for AnrWatchdog APK
        id: find-apk
        run: |
          echo "::group::Searching for APK files"
          
          # Search for APK files in the build output directory
          # This workflow prioritizes AnrWatchdog-related APKs if found
          APK_FILE=""
          
          # First, check standard build output locations
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            APK_FILE="app/build/outputs/apk/debug/app-debug.apk"
            echo "âœ“ Found debug APK: $APK_FILE"
          elif [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            APK_FILE="app/build/outputs/apk/release/app-release.apk"
            echo "âœ“ Found release APK: $APK_FILE"
          else
            # Search for any APK in build outputs, prioritizing certain names
            APK_FILES=$(find app/build/outputs/apk -type f -name "*.apk" 2>/dev/null || true)
            
            if [ -n "$APK_FILES" ]; then
              # Try to find AnrWatchdog-specific APK first
              anr_apk=$(echo "$APK_FILES" | grep -i "anrwatchdog\|anr-watchdog\|anr_watchdog" | head -n 1 || true)
              
              if [ -n "$anr_apk" ]; then
                echo "âœ“ Found AnrWatchdog APK: $anr_apk"
                APK_FILE="$anr_apk"
              else
                # Use the first APK found
                APK_FILE=$(echo "$APK_FILES" | head -n 1)
                echo "âœ“ Found APK: $APK_FILE"
              fi
            fi
          fi
          
          # Check if we found an APK
          if [ -z "$APK_FILE" ]; then
            echo "âŒ No APK files found after build"
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          # Get APK file information
          apk_size=$(wc -c < "$APK_FILE" | tr -d ' ')
          apk_name=$(basename "$APK_FILE")
          
          echo "APK Details:"
          echo "  Name: $apk_name"
          echo "  Path: $APK_FILE"
          echo "  Size: $apk_size bytes"
          
          echo "apk_found=true" >> $GITHUB_OUTPUT
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          echo "apk_name=$apk_name" >> $GITHUB_OUTPUT
          echo "apk_size=$apk_size" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"
      
      - name: Validate Appetize.io Token
        if: steps.find-apk.outputs.apk_found == 'true'
        env:
          APPETIZE_TOKEN: ${{ secrets.APPETIZE_TOKEN }}
        run: |
          echo "::group::Validating Appetize.io credentials"
          
          if [ -z "$APPETIZE_TOKEN" ]; then
            echo "âŒ ERROR: APPETIZE_TOKEN secret is not configured"
            echo "Please add APPETIZE_TOKEN as a GitHub secret in repository settings"
            echo "::endgroup::"
            exit 1
          fi
          
          echo "âœ“ APPETIZE_TOKEN is configured"
          echo "::endgroup::"
      
      - name: Upload APK to Appetize.io
        if: steps.find-apk.outputs.apk_found == 'true'
        env:
          APPETIZE_TOKEN: ${{ secrets.APPETIZE_TOKEN }}
          APK_PATH: ${{ steps.find-apk.outputs.apk_path }}
          APK_NAME: ${{ steps.find-apk.outputs.apk_name }}
        run: |
          echo "::group::Uploading APK to Appetize.io"
          
          echo "Uploading $APK_NAME to Appetize.io..."
          
          # Upload the APK to Appetize.io using their API
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -F "file=@$APK_PATH" \
            -F "platform=android" \
            -u "$APPETIZE_TOKEN:" \
            https://api.appetize.io/v1/apps)
          
          # Extract HTTP status code (last line)
          http_code=$(echo "$response" | tail -n 1)
          
          # Extract response body (all lines except last)
          response_body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status Code: $http_code"
          echo "Response Body:"
          echo "$response_body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Successfully uploaded APK to Appetize.io"
            
            # Try to extract the app URL from response using jq
            app_url=$(echo "$response_body" | jq -r '.publicURL // empty' 2>/dev/null || true)
            app_key=$(echo "$response_body" | jq -r '.publicKey // empty' 2>/dev/null || true)
            
            if [ -n "$app_url" ]; then
              echo "ðŸ“± App URL: $app_url"
            fi
            
            if [ -n "$app_key" ]; then
              echo "ðŸ”‘ App Key: $app_key"
            fi
            
            echo "Full response saved for reference"
          else
            echo "âŒ Failed to upload APK to Appetize.io"
            echo "HTTP Status: $http_code"
            echo "Response: $response_body"
            echo "::endgroup::"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Log No APK Found
        if: steps.find-apk.outputs.apk_found == 'false'
        run: |
          echo "::warning::No APK files found after build"
          echo "::group::APK Build Details"
          echo "The workflow attempted to build the Android project but no APK was generated."
          echo ""
          echo "Build output directory contents:"
          ls -R app/build/outputs/ 2>/dev/null || echo "âŒ Build outputs directory not found"
          echo ""
          echo "Possible causes:"
          echo "  1. Build failed but did not exit with error code"
          echo "  2. APK output path has changed"
          echo "  3. Build configuration issue in build.gradle.kts"
          echo ""
          echo "Expected APK locations:"
          echo "  - app/build/outputs/apk/debug/app-debug.apk"
          echo "  - app/build/outputs/apk/release/app-release.apk"
          echo "::endgroup::"
          exit 1
      
      - name: Upload Summary
        if: always()
        run: |
          echo "## Appetize.io Upload Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.find-apk.outputs.apk_found }}" == "true" ]; then
            echo "### âœ… APK Upload Completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **APK Name**: ${{ steps.find-apk.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **APK Size**: ${{ steps.find-apk.outputs.apk_size }} bytes" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Upload successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No APK Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No APK files were found in the repository." >> $GITHUB_STEP_SUMMARY
            echo "Please ensure APK files are available before running this workflow." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check FlyCI API Connectivity
        if: always()
        run: |
          echo "::group::Verifying FlyCI API connectivity"
          
          # DNS Resolution Check
          echo "ðŸ” Step 1: Checking DNS resolution for api.flyci.net..."
          if nslookup api.flyci.net > /dev/null 2>&1; then
            echo "âœ… DNS resolution successful"
            nslookup api.flyci.net
          else
            echo "âŒ ERROR: DNS resolution failed for api.flyci.net"
            echo "::error::Cannot resolve api.flyci.net. Please check network connectivity or DNS configuration."
            echo "::endgroup::"
            exit 1
          fi
          
          echo ""
          
          # HTTP Connection Check
          echo "ðŸ” Step 2: Testing HTTP connection to api.flyci.net..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 https://api.flyci.net 2>/dev/null || echo "000")
          
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… HTTP connection successful (HTTP $HTTP_CODE)"
          else
            echo "âŒ ERROR: HTTP connection failed (HTTP $HTTP_CODE)"
            echo "::error::FlyCI API at api.flyci.net is not responding with HTTP 200. Received HTTP $HTTP_CODE instead."
            echo ""
            echo "Debugging information:"
            curl -v https://api.flyci.net 2>&1 | head -20 || echo "Failed to get detailed connection info"
            echo ""
            echo "Possible causes:"
            echo "  - FlyCI API service may be down"
            echo "  - Network connectivity issues"
            echo "  - Firewall blocking outbound HTTPS connections"
            echo "  - SSL/TLS certificate issues"
            echo ""
            echo "Please verify FlyCI service status or check network configuration."
            echo "::endgroup::"
            exit 1
          fi
          
          echo ""
          echo "âœ… All FlyCI API connectivity checks passed"
          echo "::endgroup::"
      
      - name: FlyCI Wingman
        if: always()
        uses: fly-ci/wingman-action@v1
