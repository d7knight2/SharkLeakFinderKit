name: Auto Resolve Merge Conflicts

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual triggering for testing

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  resolve-conflicts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Debug Information
        run: |
          echo "::group::Environment & Permissions"
          echo "Event Name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow Permissions:"
          echo "  - contents: write"
          echo "  - pull-requests: write"
          echo "  - issues: write"
          echo "::endgroup::"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Resolve merge conflicts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Running conflict resolution script"
          bash scripts/resolve_conflicts.sh
          echo "::endgroup::"
      
      - name: Check FlyCI API Connectivity
        if: always()
        run: |
          echo "::group::Verifying FlyCI API connectivity"
          
          # DNS Resolution Check
          echo "ðŸ” Step 1: Checking DNS resolution for api.flyci.net..."
          if nslookup api.flyci.net > /dev/null 2>&1; then
            echo "âœ… DNS resolution successful"
            nslookup api.flyci.net
          else
            echo "âŒ ERROR: DNS resolution failed for api.flyci.net"
            echo "::error::Cannot resolve api.flyci.net. Please check network connectivity or DNS configuration."
            echo "::endgroup::"
            exit 1
          fi
          
          echo ""
          
          # HTTP Connection Check
          echo "ðŸ” Step 2: Testing HTTP connection to api.flyci.net..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 https://api.flyci.net 2>/dev/null || echo "000")
          
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "âœ… HTTP connection successful (HTTP $HTTP_CODE)"
          else
            echo "âŒ ERROR: HTTP connection failed (HTTP $HTTP_CODE)"
            echo "::error::FlyCI API at api.flyci.net is not responding with HTTP 200. Received HTTP $HTTP_CODE instead."
            echo ""
            echo "Debugging information:"
            curl -v https://api.flyci.net 2>&1 | head -20 || echo "Failed to get detailed connection info"
            echo ""
            echo "Possible causes:"
            echo "  - FlyCI API service may be down"
            echo "  - Network connectivity issues"
            echo "  - Firewall blocking outbound HTTPS connections"
            echo "  - SSL/TLS certificate issues"
            echo ""
            echo "Please verify FlyCI service status or check network configuration."
            echo "::endgroup::"
            exit 1
          fi
          
          echo ""
          echo "âœ… All FlyCI API connectivity checks passed"
          echo "::endgroup::"
      
      - name: FlyCI Wingman
        if: always()
        uses: fly-ci/wingman-action@v1
